CROSS_COMPILE ?= riscv64-linux-gnu-

flashinitramfs.cpio:
	GO111MODULE=off u-root -o $@ \
	github.com/u-root/u-root/cmds/boot/pxeboot \
	github.com/u-root/u-root/cmds/core/cat \
	github.com/u-root/u-root/cmds/core/elvish \
	github.com/u-root/u-root/cmds/core/init \
	github.com/u-root/u-root/cmds/core/ip \
	github.com/u-root/u-root/cmds/core/ls \
	github.com/u-root/u-root/cmds/core/kexec \
	github.com/u-root/u-root/cmds/core/pci \
	github.com/u-root/u-root/cmds/core/wget

flashkernel: flash.config
	cp $< linux/.config
	echo CONFIG_CMDLINE_BOOL=y >> linux/.config
	echo CONFIG_CMDLINE_OVERRIDE=y >> linux/.config
	echo 'CONFIG_CMDLINE="earlycon=sbi earlyprintk=ttyS0,keep console=ttyS0"' >> linux/.config
	(cd linux && ARCH=riscv make olddefconfig && ARCH=riscv CROSS_COMPILE=$(CROSS_COMPILE) make -j32)
	cp linux/arch/riscv/boot/Image $@

testflashkernel: flashkernel # flashinitramfs.cpio
	qemu-system-riscv64 -machine virt -kernel flashkernel -nographic # -initrd flashinitramfs.cpio

fetch: getkernel geturoot

getkernel:
	rm -rf linux
	git clone --depth=1 -b v5.15 https://github.com/torvalds/linux

geturoot:
	go get -u github.com/u-root/u-root
